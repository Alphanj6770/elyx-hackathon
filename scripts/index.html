<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elyx: Interactive Journey Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { background-color: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn-primary { background-color: #4f46e5; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        select { border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; width: 100%; background-color: #f9fafb; }
        .message-bubble { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 85%; word-wrap: break-word; }
        .from-elyx { background-color: #eef2ff; color: #1e1b4b; border-bottom-left-radius: 0.25rem; align-self: flex-start; }
        .from-member { background-color: #f0fdf4; color: #14532d; border-bottom-right-radius: 0.25rem; align-self: flex-end; }
        .week-header { font-size: 1.25rem; font-weight: 600; color: #4338ca; margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e0e7ff; }
        .event-tag { display: inline-block; background-color: #e0e7ff; color: #3730a3; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; margin-left: 0.5rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-700">Elyx: Interactive Journey Simulator</h1>
            <p class="mt-2 text-lg text-gray-600">Set initial diagnostic results to seed a dynamic, 8-month AI-generated member journey.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Input & Control Panel -->
            <div class="lg:col-span-2 card p-6 h-fit">
                <h2 class="text-2xl font-semibold mb-6 border-b pb-3 text-gray-700">1. Set Initial Results</h2>
                <form id="resultsForm" class="space-y-6">
                    <div>
                        <label for="apoE4" class="block text-sm font-medium text-gray-700 mb-1">ApoE4 Status</label>
                        <select id="apoE4" name="apoE4"><option value="not_present">Not Present</option><option value="one_copy">One Copy</option><option value="two_copies">Two Copies</option></select>
                    </div>
                    <div>
                        <label for="cancerScreening" class="block text-sm font-medium text-gray-700 mb-1">Cancer Screening: FIT</label>
                        <select id="cancerScreening" name="cancerScreening"><option value="negative">Negative</option><option value="positive">Positive</option></select>
                    </div>
                    <div>
                        <label for="calciumScore" class="block text-sm font-medium text-gray-700 mb-1">Coronary Calcium Score</label>
                        <select id="calciumScore" name="calciumScore"><option value="0">0</option><option value="1-99">1-99</option><option value="100-399">100-399</option><option value="400+">400+</option></select>
                    </div>
                    <div class="pt-4">
                        <button type="submit" id="generateJourneyBtn" class="btn-primary w-full flex items-center justify-center">
                            Generate Full Journey
                        </button>
                    </div>
                </form>
            </div>

            <!-- Output Panel -->
            <div class="lg:col-span-3 card p-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">2. Simulated 8-Month Journey</h2>
                <div id="timeline-container" class="h-[80vh] overflow-y-auto pr-4">
                    <div id="placeholder" class="text-center text-gray-500 mt-16">
                        <p>Your generated journey will appear here.</p>
                        <p class="text-sm">Set the initial results and click "Generate Full Journey" to begin.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Configuration & Personas ---
        const SIMULATION_WEEKS = 35;
        const ELYX_PERSONAS = {
            "Ruby": "You are Ruby, the Elyx Concierge. Role: logistics, scheduling, reminders. Voice: empathetic, organized, proactive.",
            "Dr. Warren": "You are Dr. Warren, the Medical Strategist. Role: interpret labs, set medical direction. Voice: authoritative, precise, scientific.",
            "Advik": "You are Advik, the Performance Scientist. Role: analyze wearable data (Whoop, Garmin). Voice: analytical, curious, data-driven.",
            "Carla": "You are Carla, the Nutritionist. Role: design nutrition plans. Voice: practical, educational.",
            "Rachel": "You are Rachel, the PT/Physiotherapist. Role: manage physical movement, strength training. Voice: direct, encouraging.",
            "Neel": "You are Neel, the Concierge Lead. Role: handle strategic reviews, de-escalate frustrations. Voice: strategic, reassuring."
        };
        const MEMBER_PERSONA = "You are Rohan, a 46-year-old driven, analytical, time-constrained FinTech executive. You value efficiency and evidence-based approaches.";

        // --- API Call to Backend Server ---
        async function generateConversationTurn(role, prompt, history) {
            // *** THIS IS THE KEY CHANGE ***
            const apiUrl = 'http://127.0.0.1:8000/generate'; // Points to your local FastAPI backend
            
            const persona = role === 'Rohan' ? MEMBER_PERSONA : ELYX_PERSONAS[role];

            const payload = {
                role: role,
                prompt: prompt,
                history: history,
                persona: persona
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    console.error("Backend Error:", await response.text());
                    return `[Backend Error: ${response.statusText}]`;
                }
                const data = await response.json();
                return data.text;
            } catch (error) {
                console.error("Fetch Error:", error);
                // Add a user-friendly error message to the UI
                const timelineContainer = document.getElementById('timeline-container');
                const errorEl = document.createElement('div');
                errorEl.className = 'p-4 bg-red-100 text-red-800 rounded-lg my-4';
                errorEl.innerHTML = '<strong>Connection Error:</strong> Could not connect to the backend server. Please ensure the Python server (`main.py`) is running.';
                timelineContainer.prepend(errorEl);
                return "[Connection Error]";
            }
        }

        // --- UI Rendering ---
        const timelineContainer = document.getElementById('timeline-container');
        function renderMessage(msg) {
            const messageEl = document.createElement('div');
            messageEl.className = `message-bubble ${msg.from === 'Rohan' ? 'from-member' : 'from-elyx'}`;
            messageEl.innerHTML = `<p class="font-bold text-sm">${msg.from}</p><p>${msg.text}</p>`;
            timelineContainer.appendChild(messageEl);
            timelineContainer.scrollTop = timelineContainer.scrollHeight;
        }

        function renderWeekHeader(week, eventDescription) {
            const headerEl = document.createElement('h3');
            headerEl.className = 'week-header';
            headerEl.innerHTML = `Week ${week} <span class="event-tag">${eventDescription}</span>`;
            timelineContainer.appendChild(headerEl);
        }

        // --- Simulation Engine ---
        document.getElementById('resultsForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const generateBtn = document.getElementById('generateJourneyBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = `<div class="loader mr-2"></div> Generating...`;
            
            timelineContainer.innerHTML = ''; // Clear previous results

            const initialResults = {
                apoE4: document.getElementById('apoE4').value,
                cancerScreening: document.getElementById('cancerScreening').value,
                calciumScore: document.getElementById('calciumScore').value,
            };

            const journeyState = {
                currentWeek: 0,
                isTraveling: false,
                knownIssues: [],
                history: []
            };

            // Populate initial issues from form
            if (initialResults.cancerScreening === 'positive') journeyState.knownIssues.push("Positive FIT test");
            if (parseInt(initialResults.calciumScore.split('-')[0]) >= 100) journeyState.knownIssues.push("High Calcium Score");
            if (initialResults.apoE4.includes('copy')) journeyState.knownIssues.push("ApoE4 Carrier");

            for (let week = 1; week <= SIMULATION_WEEKS; week++) {
                journeyState.currentWeek = week;
                let eventPrompt = null;
                let participants = [];
                let eventDescription = "";

                // --- Event Trigger Logic ---
                if (week === 1) {
                    eventDescription = "Onboarding";
                    eventPrompt = "Start the conversation as Rohan. You're sending your first message to Elyx, mentioning your concern about your family history of heart disease and that you feel your current health management is random.";
                    participants = ["Rohan", "Ruby"];
                } else if (week === 2 && journeyState.knownIssues.length > 0) {
                    eventDescription = "Initial Triage";
                    eventPrompt = `As Dr. Warren, address the key findings from the initial tests: ${journeyState.knownIssues.join(', ')}. Explain the next immediate step for the highest priority issue.`;
                    participants = ["Dr. Warren", "Rohan"];
                } else if (week > 8 && week % 4 === 0) {
                    eventDescription = "Travel Planning";
                    journeyState.isTraveling = true;
                    eventPrompt = "As Rohan, mention you have a last-minute business trip to London and ask for tips on managing jet lag and nutrition.";
                    participants = ["Rohan", "Advik"];
                } else if (week > 8 && week % 2 === 0 && Math.random() < 0.5) {
                     eventDescription = "Member Query";
                     eventPrompt = "As Rohan, ask a question about your Garmin/Whoop data. For example, 'My HRV was low this morning, but I feel fine. Why?'";
                     participants = ["Rohan", "Advik"];
                } else {
                    if (Math.random() > 0.6) {
                        eventDescription = "Weekly Check-in";
                        eventPrompt = "As Ruby, send a brief, proactive check-in message to Rohan. Ask if he needs any logistical support for the week ahead.";
                        participants = ["Ruby", "Rohan"];
                    }
                }

                if (eventPrompt) {
                    renderWeekHeader(week, eventDescription);
                    let currentHistory = journeyState.history.slice(-4);

                    for (const role of participants) {
                        const task = participants.indexOf(role) === 0 ? eventPrompt : `Based on the last message, write a concise and in-character response as ${role}.`;
                        const responseText = await generateConversationTurn(role, task, currentHistory);
                        if(responseText === "[Connection Error]") {
                            generateBtn.disabled = false;
                            generateBtn.innerText = "Generate Full Journey";
                            return; // Stop the simulation if backend is not running
                        }
                        const newMsg = { from: role, text: responseText };
                        renderMessage(newMsg);
                        currentHistory.push(newMsg);
                        journeyState.history.push(newMsg);
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
            }

            generateBtn.disabled = false;
            generateBtn.innerText = "Generate Full Journey";
        });
    </script>
</body>
</html>
