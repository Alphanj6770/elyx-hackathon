<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elyx: Interactive Journey Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { background-color: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn-primary { background-color: #4f46e5; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        select { border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; width: 100%; background-color: #f9fafb; }
        .message-bubble { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 85%; word-wrap: break-word; margin-bottom: 0.5rem; }
        .from-elyx { background-color: #eef2ff; color: #1e1b4b; border-bottom-left-radius: 0.25rem; align-self: flex-start; }
        .from-member { background-color: #f0fdf4; color: #14532d; border-bottom-right-radius: 0.25rem; align-self: flex-end; }
        .week-header { font-size: 1.25rem; font-weight: 600; color: #4338ca; margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e0e7ff; }
        .event-tag { display: inline-block; background-color: #e0e7ff; color: #3730a3; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; margin-left: 0.5rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .debug-info { background-color: #f3f4f6; padding: 0.5rem; margin: 0.25rem 0; border-radius: 0.25rem; font-size: 0.75rem; color: #6b7280; }
        .error-message { background-color: #fee2e2; color: #dc2626; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-700">Elyx: Interactive Journey Simulator</h1>
            <p class="mt-2 text-lg text-gray-600">Set initial diagnostic results to seed a dynamic, 8-month AI-generated member journey.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Input & Control Panel -->
            <div class="lg:col-span-2 card p-6 h-fit">
                <h2 class="text-2xl font-semibold mb-6 border-b pb-3 text-gray-700">1. Set Initial Results</h2>
                <form id="resultsForm" class="space-y-6">
                    <div>
                        <label for="apoE4" class="block text-sm font-medium text-gray-700 mb-1">ApoE4 Status</label>
                        <select id="apoE4" name="apoE4"><option value="not_present">Not Present</option><option value="one_copy">One Copy</option><option value="two_copies">Two Copies</option></select>
                    </div>
                    <div>
                        <label for="cancerScreening" class="block text-sm font-medium text-gray-700 mb-1">Cancer Screening: FIT</label>
                        <select id="cancerScreening" name="cancerScreening"><option value="negative">Negative</option><option value="positive">Positive</option></select>
                    </div>
                    <div>
                        <label for="calciumScore" class="block text-sm font-medium text-gray-700 mb-1">Coronary Calcium Score</label>
                        <select id="calciumScore" name="calciumScore"><option value="0">0</option><option value="1-99">1-99</option><option value="100-399">100-399</option><option value="400+">400+</option></select>
                    </div>
                    <div class="pt-4">
                        <button type="submit" id="generateJourneyBtn" class="btn-primary w-full flex items-center justify-center">
                            Generate Full Journey
                        </button>
                    </div>
                </form>
                
                <!-- Debug Panel -->
                <div class="mt-6 p-4 bg-gray-100 rounded-lg">
                    <h3 class="font-semibold text-sm mb-2">Debug Info:</h3>
                    <div id="debugInfo" class="text-xs text-gray-600"></div>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="lg:col-span-3 card p-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">2. Simulated 8-Month Journey</h2>
                <div id="timeline-container" class="h-[80vh] overflow-y-auto pr-4">
                    <div id="placeholder" class="text-center text-gray-500 mt-16">
                        <p>Your generated journey will appear here.</p>
                        <p class="text-sm">Set the initial results and click "Generate Full Journey" to begin.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Configuration & Personas ---
        const SIMULATION_WEEKS = 8; // Increased from 10 for better testing
        const API_BASE_URL = 'http://127.0.0.1:8000';
        
        const ELYX_PERSONAS = {
            "Ruby": "You are Ruby, the Elyx Concierge. Role: logistics, scheduling, reminders. Voice: empathetic, organized, proactive.",
            "Dr. Warren": "You are Dr. Warren, the Medical Strategist. Role: interpret labs, set medical direction. Voice: authoritative, precise, scientific.",
            "Advik": "You are Advik, the Performance Scientist. Role: analyze wearable data (Whoop, Garmin). Voice: analytical, curious, data-driven.",
            "Carla": "You are Carla, the Nutritionist. Role: design nutrition plans. Voice: practical, educational.",
            "Rachel": "You are Rachel, the PT/Physiotherapist. Role: manage physical movement, strength training. Voice: direct, encouraging.",
            "Neel": "You are Neel, the Concierge Lead. Role: handle strategic reviews, de-escalate frustrations. Voice: strategic, reassuring."
        };
        const MEMBER_PERSONA = "You are Rohan, a 46-year-old driven, analytical, time-constrained FinTech executive. You value efficiency and evidence-based approaches.";

        // Debug logging function
        function debugLog(message) {
            console.log(message);
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        // --- API Call to Backend Server ---
        async function generateConversationTurn(role, prompt, history) {
            const apiUrl = `${API_BASE_URL}/generate`;
            
            const payload = {
                role: role,
                prompt: prompt,
                history: history
            };

            debugLog(`Making API call for ${role}: ${prompt.substring(0, 50)}...`);
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                debugLog(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    debugLog(`Backend Error: ${errorText}`);
                    return `[Backend Error: ${response.status}]`;
                }
                
                const data = await response.json();
                debugLog(`Response received: ${JSON.stringify(data)}`);
                
                // Try to get text from multiple possible fields
                const responseText = data.text || data.response || data.message || "[No response text found]";
                debugLog(`Extracted text: ${responseText}`);
                
                return responseText;
                
            } catch (error) {
                debugLog(`Fetch Error: ${error.message}`);
                showError(`Connection Error: Could not connect to the backend server at ${apiUrl}. Please ensure the Python server is running.`);
                return "[Connection Error]";
            }
        }

        // --- UI Rendering ---
        const timelineContainer = document.getElementById('timeline-container');
        
        function showError(message) {
            const errorEl = document.createElement('div');
            errorEl.className = 'error-message';
            errorEl.innerHTML = `<strong>Error:</strong> ${message}`;
            timelineContainer.prepend(errorEl);
        }
        
        function renderMessage(msg) {
            const messageEl = document.createElement('div');
            messageEl.className = `message-bubble ${msg.from === 'Rohan' ? 'from-member' : 'from-elyx'}`;
            messageEl.innerHTML = `
                <p class="font-bold text-sm">${msg.from}</p>
                <p>${msg.text}</p>
            `;
            timelineContainer.appendChild(messageEl);
            timelineContainer.scrollTop = timelineContainer.scrollHeight;
        }

        function renderWeekHeader(week, eventDescription) {
            const headerEl = document.createElement('h3');
            headerEl.className = 'week-header';
            headerEl.innerHTML = `Week ${week} <span class="event-tag">${eventDescription}</span>`;
            timelineContainer.appendChild(headerEl);
        }

        // Test connection function
        async function testConnection() {
            try {
                debugLog('Testing backend connection...');
                const response = await fetch(`${API_BASE_URL}/`);
                const data = await response.json();
                debugLog(`Connection test: ${JSON.stringify(data)}`);
                return true;
            } catch (error) {
                debugLog(`Connection test failed: ${error.message}`);
                return false;
            }
        }

        // --- Simulation Engine ---
        document.getElementById('resultsForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Clear previous results and debug info
            timelineContainer.innerHTML = '';
            document.getElementById('debugInfo').innerHTML = '';
            
            // Test connection first
            const connectionOk = await testConnection();
            if (!connectionOk) {
                showError('Cannot connect to backend server. Please check if it\'s running on http://127.0.0.1:8000');
                return;
            }
            
            const generateBtn = document.getElementById('generateJourneyBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = `<div class="loader mr-2"></div> Generating...`;

            const initialResults = {
                apoE4: document.getElementById('apoE4').value,
                cancerScreening: document.getElementById('cancerScreening').value,
                calciumScore: document.getElementById('calciumScore').value,
            };

            const journeyState = {
                currentWeek: 0,
                isTraveling: false,
                knownIssues: [],
                history: []
            };

            // Populate initial issues from form
            if (initialResults.cancerScreening === 'positive') journeyState.knownIssues.push("Positive FIT test");
            if (parseInt(initialResults.calciumScore.split('-')[0]) >= 100) journeyState.knownIssues.push("High Calcium Score");
            if (initialResults.apoE4.includes('copy')) journeyState.knownIssues.push("ApoE4 Carrier");

            debugLog(`Starting simulation with issues: ${journeyState.knownIssues.join(', ')}`);

            // Call the backend /start_simulation endpoint instead of manual event generation
            try {
                debugLog('Calling backend /start_simulation endpoint...');
                const simulationResponse = await fetch(`${API_BASE_URL}/start_simulation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        months: Math.ceil(SIMULATION_WEEKS / 4.345), // Convert weeks to months
                        known_issues: initialResults
                    })
                });

                if (!simulationResponse.ok) {
                    const errorText = await simulationResponse.text();
                    debugLog(`Simulation Error: ${errorText}`);
                    showError('Failed to generate simulation from backend');
                    generateBtn.disabled = false;
                    generateBtn.innerText = "Generate Full Journey";
                    return;
                }

                const simulationData = await simulationResponse.json();
                debugLog(`Received ${simulationData.length} events from backend`);

                // Group events by week for display
                let currentWeek = 1;
                let eventsInCurrentWeek = 0;
                const maxEventsPerWeekDisplay = 8; // Limit display to prevent overwhelming UI

                for (let i = 0; i < simulationData.length && currentWeek <= SIMULATION_WEEKS; i++) {
                    const eventData = simulationData[i];
                    const event = eventData.event;
                    const conversation = eventData.conversation;

                    // Determine if we should start a new week
                    if (eventsInCurrentWeek >= maxEventsPerWeekDisplay) {
                        currentWeek++;
                        eventsInCurrentWeek = 0;
                        await new Promise(resolve => setTimeout(resolve, 200)); // Brief pause between weeks
                    }

                    if (currentWeek > SIMULATION_WEEKS) break;

                    // Display week header for first event of the week
                    if (eventsInCurrentWeek === 0) {
                        const eventTypeDisplay = event.event_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        renderWeekHeader(currentWeek, eventTypeDisplay);
                    }

                    // Display the conversation
                    for (const message of conversation) {
                        renderMessage(message);
                        await new Promise(resolve => setTimeout(resolve, 300)); // Delay between messages
                    }

                    eventsInCurrentWeek++;
                    journeyState.history.push(...conversation);
                }

            } catch (error) {
                debugLog(`Simulation Error: ${error.message}`);
                showError('Failed to generate simulation. Please check if the backend server is running.');
            }

            generateBtn.disabled = false;
            generateBtn.innerText = "Generate Full Journey";
            debugLog('Simulation completed!');
        });
        
        // Initialize with connection test
        window.addEventListener('load', testConnection);
    </script>
</body>
</html>